<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

        <title>Basics - Sims.jl</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/github.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="..">Sims.jl</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">User guide <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            <li class="active">
                                <a href=".">Basics</a>
                            </li>
                        
                            <li >
                                <a href="../plotting">Plotting results</a>
                            </li>
                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">API <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            <li >
                                <a href="../api/main">Modeling</a>
                            </li>
                        
                            <li >
                                <a href="../api/sim">Simulations</a>
                            </li>
                        
                            <li >
                                <a href="../api/utils">Utilities</a>
                            </li>
                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Standard library <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            <li >
                                <a href="../lib/types">Types</a>
                            </li>
                        
                            <li >
                                <a href="../lib/blocks">Continuous blocks</a>
                            </li>
                        
                            <li >
                                <a href="../lib/electrical">Electrical</a>
                            </li>
                        
                            <li >
                                <a href="../lib/heat_transfer">Heat transfer</a>
                            </li>
                        
                            <li >
                                <a href="../lib/powersystems">Power systems</a>
                            </li>
                        
                            <li >
                                <a href="../lib/rotational">Rotational mechanics</a>
                            </li>
                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Examples <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            <li >
                                <a href="../examples/basics">Basics</a>
                            </li>
                        
                            <li >
                                <a href="../examples/lib">Standard library</a>
                            </li>
                        
                            <li >
                                <a href="../examples/neural">Neural</a>
                            </li>
                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Design <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            <li >
                                <a href="../design">Considerations</a>
                            </li>
                        
                            <li >
                                <a href="../future">Development options</a>
                            </li>
                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            <li >
                                <a href="../NEWS">Release notes</a>
                            </li>
                        
                            <li >
                                <a href="../LICENSE">License</a>
                            </li>
                        
                        </ul>
                    </li>
                
                
                </ul>
            

            
            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                
                <li >
                    <a rel="next" href="..">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../plotting">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                
                <li>
                    <a href="https://github.com/tshort/Sims.jl/">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
            
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#documentation">Documentation</a></li>
        
            <li><a href="#unknowns">Unknowns</a></li>
        
            <li><a href="#models">Models</a></li>
        
            <li><a href="#simulating-a-model">Simulating a Model</a></li>
        
            <li><a href="#simulation-output">Simulation Output</a></li>
        
            <li><a href="#hybrid-modeling">Hybrid Modeling</a></li>
        
            <li><a href="#structurally-varying-systems">Structurally Varying Systems</a></li>
        
            <li><a href="#known-issues">Known Issues</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="documentation">Documentation</h1>
<p>This document provides a general introduction to Sims.</p>
<h2 id="unknowns">Unknowns</h2>
<p>Models consist of equations and unknown variables. The number of
equations should match the number of unknowns. In Sims, the type
Unknown is used to define unknown variables. Without the constructor
parts, the definition of Unknown is:</p>
<div class="codehilite"><pre><span class="k">type</span><span class="nc"> Unknown</span><span class="p">{</span><span class="n">T</span><span class="o">&lt;:</span><span class="n">UnknownCategory</span><span class="p">}</span> <span class="o">&lt;:</span> <span class="n">UnknownVariable</span>
    <span class="n">sym</span><span class="p">::</span><span class="n">Symbol</span>
    <span class="n">value</span>         <span class="c"># holds initial values (and type info)</span>
    <span class="n">label</span><span class="p">::</span><span class="n">String</span> 
<span class="k">end</span>
</pre></div>


<p>Unknowns can be grouped into categories. That's what the <code>T</code> is for in
the definition above. One can define different types of Unknowns
(electrical vs. mechanical for example). The default is
DefaultUnknown. Unknowns of different types can also be used to define
models of the same name that act differently depending on what type of
node they are connected to.</p>
<p>Unknowns also contain a value. This is used for setting initial
values, and these values are updated if there is a structural change
in the model. Unknowns can be different types. Eventually, all
Unknowns are converted to Float64's in an array for simulation.
Currently, Sim supports Unknowns of type Float64, Complex128, and
arrays of either of these. Adding support for other structures is not
hard as long as they can be converted to Float64's.</p>
<p>The label string is used for labeling simulation outputs. Unlabeled
Unknowns are not included in results.</p>
<p>Here are several ways to define Unknowns:</p>
<div class="codehilite"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">Unknown</span><span class="p">()</span>          <span class="c"># An initial value of 0.0 with no labeling.</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">Unknown</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">)</span>  <span class="c"># An initial value of 1.0 and a label of &quot;y&quot; on outputs.</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">Unknown</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="s">&quot;vector&quot;</span><span class="p">)</span>  <span class="c"># An Unknown with array values.</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">Unknown</span><span class="p">{</span><span class="n">Voltage</span><span class="p">}(</span><span class="mf">10.0</span><span class="p">,</span> <span class="s">&quot;Output voltage&quot;</span><span class="p">)</span>  <span class="c"># An Unknown of type Voltage</span>
</pre></div>


<p>Here are ways to create new Unknown types:</p>
<div class="codehilite"><pre><span class="c"># Untyped Unknowns:</span>
<span class="n">Angle</span> <span class="o">=</span> <span class="n">AngularVelocity</span> <span class="o">=</span> <span class="n">AngularAcceleration</span> <span class="o">=</span> <span class="n">Torque</span> <span class="o">=</span> <span class="n">RotationalNode</span> <span class="o">=</span> <span class="n">Unknown</span>

<span class="c"># Typed Unknowns:</span>
<span class="k">type</span><span class="nc"> UVoltage</span> <span class="o">&lt;:</span> <span class="n">UnknownCategory</span>
<span class="k">end</span>
<span class="k">type</span><span class="nc"> UCurrent</span> <span class="o">&lt;:</span> <span class="n">UnknownCategory</span>
<span class="k">end</span>
<span class="k">typealias</span><span class="nc"> ElectricalNode</span> <span class="n">Unknown</span><span class="p">{</span><span class="n">UVoltage</span><span class="p">}</span>
<span class="k">typealias</span><span class="nc"> Voltage</span> <span class="n">Unknown</span><span class="p">{</span><span class="n">UVoltage</span><span class="p">}</span>
<span class="k">typealias</span><span class="nc"> Current</span> <span class="n">Unknown</span><span class="p">{</span><span class="n">UCurrent</span><span class="p">}</span>
</pre></div>


<p>In model equations, derivatives are specified with der:</p>
<div class="codehilite"><pre>   <span class="n">der</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>


<p>Derivatives of Unknowns are an object of type DerUnknown. DerUnknown
objects contain an initial value, and a pointer to the Unknown object
it references. Initial values can be entered as the second
parameter to the der function:</p>
<div class="codehilite"><pre>   <span class="n">der</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c">#  The derivative of y starts with the value 3.0</span>
</pre></div>


<h2 id="models">Models</h2>
<p>Here is a model of the Van Der Pol oscillator:</p>
<div class="codehilite"><pre><span class="k">function</span><span class="nf"> Vanderpol</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">Unknown</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">)</span>   
    <span class="n">x</span> <span class="o">=</span> <span class="n">Unknown</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>       
    <span class="c"># The following gives the return value which is a list of equations.</span>
    <span class="c"># Expressions with Unknowns are kept as expressions. Regular</span>
    <span class="c"># variables are evaluated immediately (like normal).</span>
    <span class="n">Equation</span><span class="p">[</span>
        <span class="n">der</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>   <span class="c"># == 0 is assumed</span>
        <span class="n">der</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span>
    <span class="p">]</span>
<span class="k">end</span>
</pre></div>


<p>A device model is a function that returns a list of equations or other
devices that also return lists of equations. The equations each are
assumed equal to zero. In Julia, this is the best we can do, because
there isn't an equality operator (<code>==</code> doesn't fit the bill, either).</p>
<p>Models should normally be locally balanced, meaning the number of
unknowns matches the number of equations. It's pretty easy to match
unknowns and equations as shown below:</p>
<div class="codehilite"><pre><span class="k">function</span><span class="nf"> Capacitor</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">C</span><span class="p">::</span><span class="n">Real</span><span class="p">)</span> 
    <span class="n">i</span> <span class="o">=</span> <span class="n">Current</span><span class="p">()</span>              <span class="c"># Unknown #1</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">Voltage</span><span class="p">()</span>              <span class="c"># Unknown #2</span>
    <span class="n">Equation</span><span class="p">[</span>
        <span class="n">Branch</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>      <span class="c"># Equation #1 - this returns n1 - n2 - v</span>
        <span class="n">C</span> <span class="o">*</span> <span class="n">der</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span>            <span class="c"># Equation #2</span>
    <span class="p">]</span>
<span class="k">end</span>
</pre></div>


<p>In the model above, the nodes <code>n1</code> and <code>n2</code> are also Unknowns, but they
are defined outside of this model.</p>
<p>Here is the top-level circuit definition. In this case, there are no
input parameters. The ground reference <code>g</code> is assigned zero volts.</p>
<div class="codehilite"><pre><span class="k">function</span><span class="nf"> Circuit</span><span class="p">()</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">ElectricalNode</span><span class="p">(</span><span class="s">&quot;Source voltage&quot;</span><span class="p">)</span>   <span class="c"># The string indicates labeling for plots</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">ElectricalNode</span><span class="p">(</span><span class="s">&quot;Output voltage&quot;</span><span class="p">)</span>
    <span class="n">n3</span> <span class="o">=</span> <span class="n">ElectricalNode</span><span class="p">()</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c"># a ground has zero volts; it&#39;s not an Unknown.</span>
    <span class="n">Equation</span><span class="p">[</span>
        <span class="n">VSource</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">)</span>
        <span class="n">Resistor</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
        <span class="n">Resistor</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
        <span class="n">SeriesProbe</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="s">&quot;Capacitor current&quot;</span><span class="p">)</span>
        <span class="n">Capacitor</span><span class="p">(</span><span class="n">n3</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">5.0e-3</span><span class="p">)</span>
    <span class="p">]</span>
<span class="k">end</span>
</pre></div>


<p>All of the equations returned in this list of equations are other
models with different parameters.</p>
<p>In this top-level model, three new Unknowns are introduced (<code>n1</code>, <code>n2</code>,
and <code>n2</code>). Because these are nodes, each Unknown node will also cause an
equation to be generated that sums the flows into the node to be zero.</p>
<p>In this model, the voltages <code>n1</code> and <code>n2</code> are labeled, so they will
appear in the output. A SeriesProbe is used to label the current
through the capacitor.</p>
<h2 id="simulating-a-model">Simulating a Model</h2>
<p>Steps to building and simulating a model are straightforward.</p>
<div class="codehilite"><pre><span class="n">v</span> <span class="o">=</span> <span class="n">Vanderpol</span><span class="p">()</span>       <span class="c"># returns the hierarchical model</span>
<span class="n">v_f</span> <span class="o">=</span> <span class="n">elaborate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>    <span class="c"># returns the flattened model</span>
<span class="n">v_s</span> <span class="o">=</span> <span class="n">create_sim</span><span class="p">(</span><span class="n">v_f</span><span class="p">)</span> <span class="c"># returns a &quot;Sim&quot; ready for simulation</span>
<span class="n">v_yout</span> <span class="o">=</span> <span class="n">sim</span><span class="p">(</span><span class="n">v_s</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span> <span class="c"># run the simulation to 10 seconds and return</span>
                        <span class="c"># the result as an array plus column headings</span>
</pre></div>


<p>Two solvers are available: <code>dasslsim</code> and <code>sunsim</code> using the
<a href="https://github.com/tshort/Sundials.jl">Sundials</a>. Right now, <code>sim</code> is
equivalent to <code>dasslsim</code>.</p>
<p>Simulations can also be run directly from a hierarchical model:</p>
<div class="codehilite"><pre><span class="n">v_yout</span> <span class="o">=</span> <span class="n">sim</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span> 
</pre></div>


<p>Right now, there are really no options available for simulation
parameters.</p>
<h2 id="simulation-output">Simulation Output</h2>
<p>The result of a <code>sim</code> run is an object with components <code>y</code> and
<code>colnames</code>. <code>y</code> is a two-dimensional array with time slices along
rows and variables along columns. The first column is simulation
time. The remaining columns are for each unknown in the model
including derivatives. <code>colnames</code> contains the names of each of
the columns in <code>y</code> after the time column.</p>
<h2 id="hybrid-modeling">Hybrid Modeling</h2>
<p>Sims provides basic support for hybrid modeling. Discrete variables
are variables that are not involved in integration but apply when
"events" occur. Models can define events denoting changes in behavior.</p>
<p>Event is the main type used for hybrid modeling. It contains a
condition for root finding and model expressions to process after
positive and negative root crossings are detected.</p>
<div class="codehilite"><pre><span class="k">type</span><span class="nc"> Event</span> <span class="o">&lt;:</span> <span class="n">ModelType</span>
    <span class="n">condition</span><span class="p">::</span><span class="n">ModelType</span>   <span class="c"># An expression used for the event detection. </span>
    <span class="n">pos_response</span><span class="p">::</span><span class="n">Model</span>    <span class="c"># An expression indicating what to do when</span>
                           <span class="c"># the condition crosses zero positively.</span>
    <span class="n">neg_response</span><span class="p">::</span><span class="n">Model</span>    <span class="c"># An expression indicating what to do when</span>
                           <span class="c"># the condition crosses zero in the</span>
                           <span class="c"># negative direction.</span>
<span class="k">end</span>
</pre></div>


<p>The function <code>reinit</code> is used in Event responses to redefine variables.
Here is an example of a voltage source defined with a square wave:</p>
<div class="codehilite"><pre><span class="k">function</span><span class="nf"> VSquare</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">V</span><span class="p">::</span><span class="n">Real</span><span class="p">,</span> <span class="n">f</span><span class="p">::</span><span class="n">Real</span><span class="p">)</span>  
    <span class="n">i</span> <span class="o">=</span> <span class="n">Current</span><span class="p">()</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">Voltage</span><span class="p">()</span>
    <span class="n">v_mag</span> <span class="o">=</span> <span class="n">Discrete</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Equation</span><span class="p">[</span>
        <span class="n">Branch</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">-</span> <span class="n">v_mag</span>
        <span class="n">Event</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">pi</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="n">MTime</span><span class="p">),</span>
              <span class="n">Equation</span><span class="p">[</span><span class="n">reinit</span><span class="p">(</span><span class="n">v_mag</span><span class="p">,</span> <span class="n">V</span><span class="p">)],</span>    <span class="c"># positive crossing</span>
              <span class="n">Equation</span><span class="p">[</span><span class="n">reinit</span><span class="p">(</span><span class="n">v_mag</span><span class="p">,</span> <span class="o">-</span><span class="n">V</span><span class="p">)])</span>   <span class="c"># negative crossing</span>
    <span class="p">]</span>
<span class="k">end</span>
</pre></div>


<p>The variable v_mag is the Discrete variable that is changed using
reinit whenever the <code>sin(2 * pi * f * MTime)</code> crosses zero. A response
is provided for both positive and negative zero crossings.</p>
<p>Two other constructs that are useful are BoolEvent and ifelse. 
ifelse is like an if-then-else block, but for ModelTypes (you can't
use a regular if-then-else block, at least not without macros).<br />
BoolEvent is a helper for attaching an event to a boolean variable.
Here is an example for an ideal diode:</p>
<div class="codehilite"><pre><span class="k">function</span><span class="nf"> IdealDiode</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">Current</span><span class="p">()</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">Voltage</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">Unknown</span><span class="p">()</span>  <span class="c"># dummy variable</span>
    <span class="n">openswitch</span> <span class="o">=</span> <span class="n">Discrete</span><span class="p">(</span><span class="n">false</span><span class="p">)</span>  <span class="c"># on/off state of diode</span>
    <span class="n">Equation</span><span class="p">[</span>
        <span class="n">Branch</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">BoolEvent</span><span class="p">(</span><span class="n">openswitch</span><span class="p">,</span> <span class="o">-</span><span class="n">s</span><span class="p">)</span>  <span class="c"># openswitch becomes true when s goes negative</span>
        <span class="n">v</span> <span class="o">-</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">openswitch</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> 
        <span class="n">i</span> <span class="o">-</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">openswitch</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> 
    <span class="p">]</span>
<span class="k">end</span>
</pre></div>


<h2 id="structurally-varying-systems">Structurally Varying Systems</h2>
<p><code>StructuralEvent</code> defines a type for elements that change the structure
of the model. An event is created, and when the event is triggered,
the model is re-flattened after replacing <code>default</code> with
<code>new_relation</code> in the model.</p>
<div class="codehilite"><pre><span class="k">type</span><span class="nc"> StructuralEvent</span> <span class="o">&lt;:</span> <span class="n">ModelType</span>
    <span class="n">condition</span><span class="p">::</span><span class="n">ModelType</span>   <span class="c"># Expression indicating a zero crossing for event detection.</span>
    <span class="n">default</span>                <span class="c"># The default relation.</span>
    <span class="n">new_relation</span><span class="p">::</span><span class="n">Function</span> <span class="c"># Function to call when the new relation is needed.</span>
    <span class="n">activated</span><span class="p">::</span><span class="kt">Bool</span>        <span class="c"># Used internally to indicate whether the event fired.</span>
<span class="k">end</span>
</pre></div>


<p>Here is an example for a breaking pendulum. The model starts with the
Pendulum construct. Then, when five seconds is reached, the
StructuralEvent triggers, and the model is recompiled with the
FreeFall construct.</p>
<div class="codehilite"><pre><span class="k">function</span><span class="nf"> BreakingPendulum</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">Unknown</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="nb">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">),</span> <span class="s">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">Unknown</span><span class="p">(</span><span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="nb">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">),</span> <span class="s">&quot;y&quot;</span><span class="p">)</span>
    <span class="n">vx</span> <span class="o">=</span> <span class="n">Unknown</span><span class="p">()</span>
    <span class="n">vy</span> <span class="o">=</span> <span class="n">Unknown</span><span class="p">()</span>
    <span class="n">Equation</span><span class="p">[</span>
        <span class="n">StructuralEvent</span><span class="p">(</span><span class="n">MTime</span> <span class="o">-</span> <span class="mf">5.0</span><span class="p">,</span>     <span class="c"># when time hits 5 sec, switch to FreeFall</span>
            <span class="n">Pendulum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">vx</span><span class="p">,</span><span class="n">vy</span><span class="p">),</span>
            <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FreeFall</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">vx</span><span class="p">,</span><span class="n">vy</span><span class="p">))</span>
    <span class="p">]</span>
<span class="k">end</span>
</pre></div>


<p>One special thing to note is that <code>new_relation</code> must be a function (in
the case above, an anonymous function). If <code>new_relation</code> is not a
function, it will evaluate right away. The use of a function delays
evaluation until the model is recompiled.</p>
<h2 id="known-issues">Known Issues</h2>
<ul>
<li>Things are not tested much.</li>
</ul>
</div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/prettify-1.0.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
    </body>
</html>